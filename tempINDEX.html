<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minecraft Manager</title>
    <link rel="icon"
        href="data:image/x-icon;base64,AAABAAEAEBAQAAEABADoAgAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #212529;
            color: #f8f9fa;
            margin: 0;
        }

        .instances-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .instance-list-container {
            flex: 0 0 220px;
            overflow-y: auto;
            margin-left: 10px;
        }

        .instance-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            padding-right: 10px;
        }

        .terminal-output {
            background: black;
            color: lime;
            padding: 1rem;
            min-height: 700px;
            max-height: 700px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        #console-output {
            background: black !important;
            color: lime !important;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-y: auto;
            height: 100%;
            width: 100%;
        }

        .file-content {
            background: #343a40;
            color: #f8f9fa;
            width: 100%;
            height: 300px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .instances-layout {
                flex-direction: column;
            }

            .instance-list-container {
                width: 100%;
                margin-left: 0;
                margin-bottom: 10px;
            }

            .instance-details {
                padding-right: 0;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Minecraft Manager</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('status')">Server Status</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('instances')">Instances</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('terminal')">Terminal</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Server Status Page -->
        <div id="page-status" class="page" style="display: none;">
            <h2>Server Status</h2>
            <p id="system-usage">Loading...</p>
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>CPU (%)</th>
                        <th>Memory (MB)</th>
                    </tr>
                </thead>
                <tbody id="status-instances-table"></tbody>
            </table>
        </div>

        <!-- Instances Page -->
        <div id="page-instances" class="page" style="display: none;">
            <h2>Instances</h2>
            <div class="instances-layout">
                <div class="instance-list-container">
                    <ul class="list-group" id="instance-list"></ul>
                    <button class="btn btn-success mt-2 w-100" onclick="showNewInstanceModal()">New Instance</button>
                </div>

                <div id="instance-details" class="instance-details" style="display: none;">
                    <h4 id="instance-name"></h4>
                    <div id="instance-controls" class="mb-3"></div>
                    <h5>Console Output</h5>
                    <div id="console-output" class="terminal-output"></div>
                    <input type="text" id="console-input" class="form-control mt-2" placeholder="Enter command..."
                        onkeydown="sendCommand(event)" autocomplete="off" />
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" onclick="openFileManager()">File Manager</button>
                        <button class="btn btn-secondary" onclick="openInstanceSettings()">Instance Settings</button>
                    </div>
                    <div id="file-manager-container" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Terminal Page -->
        <div id="page-terminal" class="page" style="display: none;">
            <h2>Terminal</h2>
            <div id="terminal-login">
                <input type="password" id="terminal-password" class="form-control w-25 d-inline"
                    placeholder="Enter password" />
                <button class="btn btn-primary" onclick="authTerminal()">Login</button>
            </div>
            <div id="terminal-shell" style="display: none;">
                <div class="terminal-output" id="terminal-output"></div>
                <input type="text" id="terminal-input" class="form-control mt-2" placeholder="Enter shell command..."
                    onkeydown="sendTerminalCommand(event)" autocomplete="off" />
            </div>
        </div>
    </div>

    <!-- New Instance Modal -->
    <div class="modal fade" id="newInstanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">New Instance</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Instance Name</label>
                        <input class="form-control" id="new-name" placeholder="e.g. velocityServer" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Working Directory</label>
                        <input class="form-control" id="new-dir" placeholder="/home/mc/velocity" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Runtime Command</label>
                        <input class="form-control" id="new-cmd" placeholder='java -Xms1G -Xmx2G -jar velocity.jar' />
                        <div class="form-text text-light">Enter full command line to run the server.</div>
                    </div>
                    <button class="btn btn-success" onclick="saveNewInstance()">Save Instance</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedInstance = null;
        let wsInstance = null;
        let wsTerminal = null;
        let currentFileManagerDir = '.';

        function showPage(page) {
            document.querySelectorAll(".page").forEach(p => p.style.display = "none");
            document.getElementById(`page-${page}`).style.display = "block";

            document.querySelectorAll(".nav-link").forEach(n => n.classList.remove("active"));
            document.querySelector(`.nav-link[onclick*='${page}']`)?.classList.add("active");

            if (page === "status") loadSystemStatus();
            else if (page === "instances") loadInstances();
        }

        async function loadSystemStatus() {
            const res = await fetch('/api/system');
            const data = await res.json();
            document.getElementById("system-usage").innerText =
                `CPU: ${data.cpu.toFixed(1)}% | Memory: ${data.memoryUsedMB.toFixed(1)} MB / ${data.memoryTotalMB.toFixed(1)} MB`;

            const instRes = await fetch('/api/instances');
            const instances = await instRes.json();

            let rows = '';
            for (const name in instances) {
                const inst = instances[name];
                rows += `<tr>
                    <td>${name}</td>
                    <td>${inst.status}</td>
                    <td>${inst.cpu.toFixed(1)}</td>
                    <td>${inst.memory.toFixed(1)}</td>
                </tr>`;
            }
            document.getElementById("status-instances-table").innerHTML = rows;
        }

        async function loadInstances() {
            const res = await fetch('/api/instances');
            const instances = await res.json();
            const list = document.getElementById("instance-list");
            list.innerHTML = '';

            for (const name in instances) {
                const inst = instances[name];
                const li = document.createElement('li');
                li.className = "list-group-item list-group-item-dark";
                li.textContent = `${name} (${inst.status})`;
                li.onclick = () => selectInstance(name);
                if (name === selectedInstance) li.classList.add("active");
                list.appendChild(li);
            }

            if (selectedInstance) {
                selectInstance(selectedInstance);
            } else {
                document.getElementById("instance-details").style.display = "none";
            }
        }

        async function selectInstance(name) {
            selectedInstance = name;
            document.getElementById("instance-details").style.display = "block";
            document.getElementById("instance-name").innerText = name;

            document.querySelectorAll("#instance-list .list-group-item").forEach(el => {
                el.classList.toggle("active", el.textContent.startsWith(name));
            });

            document.getElementById("instance-controls").innerHTML = `
                <button class="btn btn-success me-2" onclick="startInstance()">Start</button>
                <button class="btn btn-danger me-2" onclick="stopInstance()">Stop</button>
                <button class="btn btn-warning me-2" onclick="restartInstance()">Restart</button>
                <button class="btn btn-outline-danger me-2" onclick="terminateInstance()">Terminate</button>`;

            if (wsInstance) wsInstance.close();

            wsInstance = new WebSocket(`ws://${location.host}`);
            wsInstance.onopen = () => {
                wsInstance.send(JSON.stringify({ type: "subscribe", instance: name }));
            };
            wsInstance.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === "log") {
                    const out = document.getElementById("console-output");
                    out.textContent += data.text;
                    out.scrollTop = out.scrollHeight;
                }
                else if (data.type === "statusUpdate") {
                    if (data.status === 'stopped' && data.instance === selectedInstance) {
                        loadInstances();
                    }
                }
            };

            const logsRes = await fetch(`/api/instances/${name}/logs`);
            const logs = await logsRes.text();
            document.getElementById("console-output").textContent = logs;
        }

        async function startInstance() {
            if (!selectedInstance) return alert("Select an instance first.");
            await fetch(`/api/instances/${selectedInstance}/start`, { method: "POST" });
            loadInstances();
        }

        async function stopInstance() {
            if (!selectedInstance) return alert("Select an instance first.");
            await fetch(`/api/instances/${selectedInstance}/stop`, { method: "POST" });
            loadInstances();
        }

        async function restartInstance() {
            if (!selectedInstance) return alert("Select an instance first.");
            await stopInstance();
            await startInstance();
        }

        async function terminateInstance() {
            if (!selectedInstance) return alert("Select an instance first.");
            await fetch(`/api/instances/${selectedInstance}/terminate`, { method: "POST" });
            loadInstances();
        }

        function sendCommand(e) {
            if (e.key === "Enter") {
                const cmd = e.target.value.trim();
                if (!cmd) return;
                fetch(`/api/instances/${selectedInstance}/command`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command: cmd })
                });
                e.target.value = "";
            }
        }

        function showNewInstanceModal() {
            const modal = new bootstrap.Modal(document.getElementById('newInstanceModal'));
            modal.show();
        }

        async function saveNewInstance() {
            const name = document.getElementById('new-name').value.trim();
            const dir = document.getElementById('new-dir').value.trim();
            const cmd = document.getElementById('new-cmd').value.trim();

            if (!name || !dir || !cmd) {
                return alert("Please fill all fields");
            }

            try {
                const res = await fetch('/api/instances', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, workingDir: dir, command: cmd })
                });

                if (!res.ok) {
                    const contentType = res.headers.get("content-type") || "";
                    let errorText;
                    if (contentType.includes("application/json")) {
                        const errorData = await res.json();
                        errorText = errorData.error || JSON.stringify(errorData);
                    } else {
                        errorText = await res.text();
                    }
                    return alert("Error: " + (errorText || "Unknown error"));
                }

                bootstrap.Modal.getInstance(document.getElementById('newInstanceModal')).hide();
                loadInstances();

            } catch (err) {
                console.error("Save instance error:", err);
                alert("Network or server error: " + err.message);
            }
        }

        function openFileManager() {
            loadFolder(currentFileManagerDir);
        }

        async function loadFolder(path) {
            currentFileManagerDir = path;
            try {
                const res = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                if (!res.ok) throw new Error("Failed to list files.");
                const files = await res.json();

                let html = `
          <h5>File Manager: ${escapeHtml(path)}</h5>
          <ul class="list-group mb-2">`;

                if (path !== "." && path !== "/") {
                    const parentPath = path.split("/").slice(0, -1).join("/") || ".";
                    html += `<li class="list-group-item list-group-item-action" onclick="loadFolder('${parentPath}')">[..]</li>`;
                }

                for (const file of files) {
                    if (file.type === "directory") {
                        html += `<li class="list-group-item list-group-item-action" onclick="loadFolder('${pathJoin(path, file.name)}')">[${escapeHtml(file.name)}]</li>`;
                    } else {
                        html += `<li class="list-group-item list-group-item-action" onclick="openFile('${pathJoin(path, file.name)}')">${escapeHtml(file.name)}</li>`;
                    }
                }

                html += `</ul>
          <form onsubmit="uploadFile(event)">
            <div class="input-group mb-2">
              <input type="file" class="form-control" id="upload-file" required />
              <button class="btn btn-primary" type="submit">Upload</button>
            </div>
          </form>
        `;
                document.getElementById("file-manager-container").innerHTML = html;
            } catch (err) {
                alert("Error loading folder.");
            }
        }

        async function openFile(path) {
            try {
                const res = await fetch(`/api/files/open?path=${encodeURIComponent(path)}`);
                if (!res.ok) throw new Error("Failed to open file.");
                const text = await res.text();

                let html = `
          <h5>Editing File: ${escapeHtml(path)}</h5>
          <textarea id="file-content" class="form-control file-content mb-2">${escapeHtml(text)}</textarea>
          <button class="btn btn-success me-2" onclick="saveFile('${path}')">Save</button>
          <button class="btn btn-danger" onclick="deleteFile('${path}')">Delete</button>
          <button class="btn btn-secondary" onclick="loadFolder('${currentFileManagerDir}')">Back</button>
        `;
                document.getElementById("file-manager-container").innerHTML = html;
            } catch (err) {
                alert("Error opening file.");
            }
        }

        async function saveFile(path) {
            const content = document.getElementById("file-content").value;
            try {
                const res = await fetch(`/api/files/save?path=${encodeURIComponent(path)}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content })
                });
                if (!res.ok) throw new Error(await res.text());
                alert("File saved.");
                loadFolder(currentFileManagerDir);
            } catch (err) {
                alert("Error saving file: " + err.message);
            }
        }

        async function deleteFile(path) {
            if (!confirm("Delete this file?")) return;
            try {
                const res = await fetch(`/api/files/delete?path=${encodeURIComponent(path)}`, {
                    method: "POST"
                });
                if (!res.ok) throw new Error(await res.text());
                alert("File deleted.");
                loadFolder(currentFileManagerDir);
            } catch (err) {
                alert("Error deleting file: " + err.message);
            }
        }

        async function uploadFile(e) {
            e.preventDefault();
            const fileInput = document.getElementById("upload-file");
            const file = fileInput.files[0];
            if (!file) return alert("No file selected.");
            const formData = new FormData();
            formData.append("file", file);
            formData.append("path", currentFileManagerDir);
            try {
                const res = await fetch("/api/files/upload", {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) throw new Error(await res.text());
                alert("Upload complete.");
                loadFolder(currentFileManagerDir);
            } catch (err) {
                alert("Upload error: " + err.message);
            }
        }

        function authTerminal() {
            const pw = document.getElementById("terminal-password").value;
            if (pw === "secret") {
                document.getElementById("terminal-login").style.display = "none";
                document.getElementById("terminal-shell").style.display = "block";

                wsTerminal = new WebSocket(`ws://${location.host}`);
                wsTerminal.onopen = () => {
                    wsTerminal.send(JSON.stringify({ type: "shell" }));
                };
                wsTerminal.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.type === "shell") {
                        const out = document.getElementById("terminal-output");
                        out.textContent += data.text;
                        out.scrollTop = out.scrollHeight;
                    }
                };
                wsTerminal.onerror = (err) => {
                    alert("Terminal WebSocket error. Make sure the server supports it.");
                };
            } else {
                alert("Wrong password!");
            }
        }

        function sendTerminalCommand(e) {
            if (e.key === "Enter") {
                const cmd = e.target.value.trim();
                if (!cmd) return;
                try {
                    wsTerminal.send(JSON.stringify({ type: "shellCmd", command: cmd }));
                } catch (err) {
                    alert("WebSocket not connected.");
                }
                e.target.value = "";
            }
        }

        showPage('status');
    </script>
</body>

</html>